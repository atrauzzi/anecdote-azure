#!/bin/bash


DEPLOYMENT_PASSWORD=`az appservice web deployment list-site-credentials \
    --resource-group $ANECDOTE_AZURE_DEPLOYMENT_NAME \
    --name ${ANECDOTE_AZURE_DEPLOYMENT_NAME}-engine \
    --query publishingPassword \
    --output tsv`

DEPLOYMENT_USERNAME=`az appservice web deployment list-site-credentials \
     --resource-group $ANECDOTE_AZURE_DEPLOYMENT_NAME \
     --name ${ANECDOTE_AZURE_DEPLOYMENT_NAME}-engine \
     --query publishingUserName \
     --output tsv`

DEPLOYMENT_HOST=`az appservice web deployment list-site-credentials \
     --resource-group $ANECDOTE_AZURE_DEPLOYMENT_NAME \
     --name ${ANECDOTE_AZURE_DEPLOYMENT_NAME}-engine \
     --query name \
     --output tsv`

PAIR="${DEPLOYMENT_USERNAME}:${DEPLOYMENT_PASSWORD}"
PAIR=$(echo $PAIR|tr -d '\n')

AUTHORIZATION_TOKEN=`echo -ne "$PAIR" | base64 -w 0`

AUTHORIZATION_HEADER="Authorization: Basic ${AUTHORIZATION_TOKEN}"

rm functions.zip
cd functions
zip -r -v ../functions.zip *
cd ..

echo "Clearing secrets"
curl -X POST https://${DEPLOYMENT_HOST}.scm.azurewebsites.net/api/command --header "${AUTHORIZATION_HEADER}" --header "content-type: application/json" -d '{"dir": "site", "command": "rm /s /q home/data/Functions/secrets/host.json"}'

echo "Wiping web directory"
curl -X POST https://${DEPLOYMENT_HOST}.scm.azurewebsites.net/api/command --header "${AUTHORIZATION_HEADER}" --header "content-type: application/json" -d '{"dir": "site", "command": "rd /s /q wwwroot"}'
curl -X POST https://${DEPLOYMENT_HOST}.scm.azurewebsites.net/api/command --header "${AUTHORIZATION_HEADER}" --header "content-type: application/json" -d '{"dir": "site", "command": "md wwwroot"}'

echo "Uploading functions"
curl -X PUT https://${DEPLOYMENT_HOST}.scm.azurewebsites.net/api/zip/site/wwwroot --header "${AUTHORIZATION_HEADER}" --upload-file functions.zip
