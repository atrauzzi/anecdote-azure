#!/bin/bash


DEPLOYMENT_PASSWORD=`az appservice web deployment list-site-credentials \
    --resource-group $ANECDOTE_AZURE_DEPLOYMENT_NAME \
    --name ${ANECDOTE_AZURE_DEPLOYMENT_NAME}-engine \
    --query publishingPassword \
    --output tsv`

DEPLOYMENT_USERNAME=`az appservice web deployment list-site-credentials \
     --resource-group $ANECDOTE_AZURE_DEPLOYMENT_NAME \
     --name ${ANECDOTE_AZURE_DEPLOYMENT_NAME}-engine \
     --query publishingUserName \
     --output tsv`

DEPLOYMENT_HOST=`az appservice web deployment list-site-credentials \
     --resource-group $ANECDOTE_AZURE_DEPLOYMENT_NAME \
     --name ${ANECDOTE_AZURE_DEPLOYMENT_NAME}-engine \
     --query name \
     --output tsv`

PAIR="${DEPLOYMENT_USERNAME}:${DEPLOYMENT_PASSWORD}"
PAIR=$(echo $PAIR|tr -d '\n')

AUTHORIZATION_TOKEN=`echo -ne "$PAIR" | base64 -w 0`

AUTHORIZATION_HEADER="Authorization: Basic ${AUTHORIZATION_TOKEN}"

rm functions.zip
cd functions
zip -r -v ../functions.zip *
cd ..

echo "Stopping App Service"
az appservice web stop \
    --resource-group $ANECDOTE_AZURE_DEPLOYMENT_NAME \
    --name ${ANECDOTE_AZURE_DEPLOYMENT_NAME}-engine

echo "Clearing secrets"
curl -X POST https://${DEPLOYMENT_HOST}.scm.azurewebsites.net/api/command --header "${AUTHORIZATION_HEADER}" --header "content-type: application/json" -d '{"dir": "data", "command": "rm Functions/secrets/host.json"}'


echo "Deleting previous deployment"
curl -X POST https://${DEPLOYMENT_HOST}.scm.azurewebsites.net/api/command --header "${AUTHORIZATION_HEADER}" --header "content-type: application/json" -d '{"dir": "site", "command": "del /f/s/q wwwroot > nul"}'

#curl -X POST https://${DEPLOYMENT_HOST}.scm.azurewebsites.net/api/command --header "${AUTHORIZATION_HEADER}" --header "content-type: application/json" -d '{"dir": "site", "command": "rmdir /S /Q wwwroot"}'
#curl -X POST https://${DEPLOYMENT_HOST}.scm.azurewebsites.net/api/command --header "${AUTHORIZATION_HEADER}" --header "content-type: application/json" -d '{"dir": "site", "command": "rmdir /S /Q wwwroot"}'
#curl -X POST https://${DEPLOYMENT_HOST}.scm.azurewebsites.net/api/command --header "${AUTHORIZATION_HEADER}" --header "content-type: application/json" -d '{"dir": "site", "command": "rmdir /S /Q wwwroot"}'

echo "Preparing new directory"
curl -X POST https://${DEPLOYMENT_HOST}.scm.azurewebsites.net/api/command --header "${AUTHORIZATION_HEADER}" --header "content-type: application/json" -d '{"dir": "site", "command": "md wwwroot"}'

echo "Uploading Functions"
curl -X PUT https://${DEPLOYMENT_HOST}.scm.azurewebsites.net/api/zip/site/wwwroot --header "${AUTHORIZATION_HEADER}" --upload-file functions.zip

echo "Starting App Service"
az appservice web stop \
    --resource-group $ANECDOTE_AZURE_DEPLOYMENT_NAME \
    --name ${ANECDOTE_AZURE_DEPLOYMENT_NAME}-engine
